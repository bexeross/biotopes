---
title: "megaTwin deep summaries - R Notebook"
output: html_notebook
---
USE WITH PROVISIONAL CLASS ALLOCATIONS

As even splitting into smaller twintables can result in some being too big to digest, we want to try and summarise groups at different levels for their average pseudospp., n, max pseudospp? to be better able to compare sub-branches.

#NB
If you came from NEWDATA_4_compareNew2Old_twinspan.RMD then you have already done the first few steps and just need to slot in the object you made in that script around line 80 (search for title "If you came from NEWDATA_4_compareNew2Old_twinspan.RMD" to find your starting point.)

#library
```{r}
library(twinspan)
library(dplyr, quietly = TRUE)
library(tibble)
library(Matrix)
library(rgdal)
```

#provisional classes
likely identified from the heatmap analysis. These will be labelled from 1 (left) to n with the prefix listed below (currently "V").
```{r}
# # Set number of classes needed
# n<-19
# 
# # Make reclassification table
# reclassify <- data.frame(level=c(6,6,4,5,7,8,8,6,5,5,4,5,6,6,5,5,4,1,5),
#                          class=c(71,70,16,36,148,298,299,75,38,39,23,45,89,88,40,41,21,3,34),
#                          new_class=sprintf("V%s",seq(1:n)))


#PÃ¥l classes
n<-26

# Make reclassification table
reclassify <- data.frame(level=c(6,6,5,4,7,7,6,7,8,8,6,5,5,4,5,6,6,6,6,7,7,5,6,6,1,6),
                         class=c(71,70,34,16,147,146,72,148,298,299,75,38,39,23,45,89,88,81,80,164,165,43,84,85,3,83),
                         new_class=sprintf("P%s",seq(1:n)))




```


# matrix
we need the twintable matrix to work with, which we can get with twin2mat and this needs to be merged with res
```{r}
tw_1.df<-rownames_to_column(as.data.frame(twin2mat(tw_1)))


#make res again if need be
res<-data.frame(SampID = samples, level1 = NA, level2= NA, level3 = NA, level4 = NA, level5 = NA, level6 = NA, level7 = NA, level8= NA, level9 = NA, level10 = NA, level11 = NA, level12 = NA, level13 = NA, level14= NA, level15 = NA)
 
 for(i in 1:15){
   res[,i+1]<-cut(tw_1, level = i)
 }
 
 f = function(x) length(unique(x))
 lapply(res, FUN = f)
 
#join together
res.mat<-left_join(res, tw_1.df, by = c("SampID"="rowname"))
res.matREF<-res.mat

rownames(res.mat) <- res.mat[,1]
```

# Reclassify dataset
```{r}
# Reclassify
for(i in 1:n){
  res.mat[getsamplesingrp(res.matREF,reclassify$level[i],reclassify$class[i]),"class"]<-as.character(reclassify$new_class[i])
}

table(res.mat$class)

my.subs<-res.mat
#my.subs<-subset(res.mat,level8 ==298) #change as needed

```
# IF YOU CAME FROM NEWDATA_4_compareNew2Old_twinspan.RMD
You have already done the steps above and just need to slot in the object you made in that script
```{r}
my.subs<-my.subs.tw2
```



# make shapefile

```{r}
my.shp <- SpatialPointsDataFrame(coords = cbind(sample_info$x_coord[match(my.subs$SampID,sample_info$SampID)],                                 sample_info$y_coord[match(my.subs$SampID,sample_info$SampID)]),
                                 proj4string = CRS("+init=epsg:32633"),
                                 data = my.subs)

writeOGR(my.shp, dsn = file.path(outPath, "Spatial"), "Mega_TMPclass_shape_big", driver = "ESRI Shapefile", overwrite_layer = TRUE)


#smaller shp
my.subs.small<-my.subs %>%
  select(SampID,class,level1,level2,level3,level4,level5,level6,level7,level8,level9,level10,level11,level12,level13,level14,level15)

my.shp.s <- SpatialPointsDataFrame(coords = cbind(sample_info$x_coord[match(my.subs.small$SampID,sample_info$SampID)],                           sample_info$y_coord[match(my.subs.small$SampID,sample_info$SampID)]),
                                 proj4string = CRS("+init=epsg:32633"),
                                 data = my.subs.small)

writeOGR(my.shp.s, dsn = file.path(outPath, "Spatial"), "Mega_TMPclass_shape_small", driver = "ESRI Shapefile", overwrite_layer = TRUE)

```

# Add trawl data
```{r}
#merge trawl mark data (make ure you have run "data_prep_trawlmarks.Rmd" first) Need to do this after summarising env var as there are too many NAs in trawl marks to get goo summaries
trawlwide.cln<-trawlwide %>%
  group_by(SampID) %>%
  summarise(TrawlmarkDens=max(`Trawl mark`))


my.subs<- my.subs %>%
  left_join(., trawlwide.cln, by =c("SampID"="SampID"))%>%
  replace(is.na(.), 0)




```





# pivot at given class level

## metadata
Make table of metadata (parent groups, n sub groups at level 15, and n samples per group)

```{r}
#parent groups
piv.meta.a<-my.subs %>%
  group_by(class)%>% # change to level you want to see groups at
  summarise(across(c(2:15),mean)) %>%
  t()%>%
  `colnames<-`(.[1, ])%>%
  .[-1, ]

# n lev 15 groups
piv.meta.15<-my.subs %>%
  group_by(class)%>% # change to level you want to see groups at
  summarise(nSubGpL15 = n_distinct(level15)) %>%
  t()%>%
  as.data.frame() %>%
  `colnames<-`(.[1, ])%>%
  .[-1, ]

# # n samples
# piv.meta.g<-my.subs %>%
#   group_by(class)%>% # change to level you want to see groups at
#   summarise(nSamp=n_distinct(SampID)) %>%
#   t()%>%
#   as.data.frame() %>%
#   `colnames<-`(.[1, ])%>%
#   .[-1, ]%>%
#   type.convert()

# n samples
piv.meta.g<-my.subs %>%
  group_by(class)%>% # change to level you want to see groups at
  summarise(nSamp=n_distinct(SampID),
            trawlm_Max=max(TrawlmarkDens)) %>%
  t()%>%
  as.data.frame() %>%
  `colnames<-`(.[1, ])%>%
  .[-1, ]%>%
  type.convert()


piv.meta<-rbind(piv.meta.a,piv.meta.15,piv.meta.g)
```

## full summary dataset
Make tables of average psuedospp per class/proportion of obs per class/max pseudospp per class

*Average pseudospp*
```{r}
piv.av<-my.subs %>%
  group_by(class)%>% # change to level you want to see groups at
  summarise(across(c(17:343),mean)) %>%
  t()%>%
  `colnames<-`(.[1, ])%>%
  .[-1, ] %>%
  type.convert()

#piv.av[,] <- sapply(piv.av[,], as.numeric)


round_df <- function(x, digits) {
    # round all numeric variables
    # x: data frame 
    # digits: number of digits to round
    numeric_columns <- sapply(x, mode) == 'numeric'
    x[numeric_columns] <-  round(x[numeric_columns], digits)
    x
}

piv.av<-round_df(piv.av, 1)
```

*proportion obs*
i.e. proportion of n spp obs (non zero pseudospp)/n samples per group
```{r}
piv.n<-my.subs %>%
  group_by(class)%>% # change to level you want to see groups at
  summarise(across(c(17:343),nnzero)) %>%
  t()%>%
  as.data.frame() %>%
  `colnames<-`(.[1, ])%>%
  .[-1, ] %>%
  type.convert()

#piv.meta.g[,] <- sapply(piv.meta.g[,], as.numeric)
#piv.n[,] <- sapply(piv.n[,], as.numeric)

piv.prop<-mapply('/',piv.n,piv.meta.g)
rownames(piv.prop)<-rownames(piv.n)
piv.prop<-round_df(piv.prop,2)

```

*Max pseudospp*
Make table of maximum pseudospp per group
```{r}
piv.mx<-my.subs %>%
  group_by(class)%>% # change to level you want to see groups at
  summarise(across(c(17:343),max)) %>%
  t()%>%
  `colnames<-`(.[1, ])%>%
  .[-1, ]
```

Combine for outputting
```{r}
out.piv<-cbind(piv.av, piv.prop, piv.mx)
values<-c(rep("av",ncol(piv.av)), rep("prop",ncol(piv.prop)), rep("max", ncol(piv.mx)))

out.piv<-rbind(values, out.piv)
```

## short form summary
I.e. dominant spp (av >1pseudospp) and consistent spp (present in >50% samples).

*Dominant*
```{r}
dom.av<-piv.av%>%
  as.data.frame() %>%
  filter_all(any_vars(. > 1))%>%
  rownames_to_column("taxa")
```

*Consistent*
```{r}
hi.prop<-piv.prop%>%
  as.data.frame() %>%
  filter_all(any_vars(. > 0.5))%>%
  rownames_to_column("taxa")
```

combine

```{r}
#short.sum<-cbind(dom.av,hi.prop)
short.sum<-dom.av%>%
  left_join(hi.prop, by=c("taxa"="taxa"))
values2<-c(rep("av>1",ncol(dom.av)), rep("prop>.5",ncol(hi.prop)))

out.piv.short<-rbind(values2, short.sum)
```


#output csvs

```{r}
# write.csv(piv.av, 
#           file = file.path(outPath, ("V6_av_pseudoSpp.csv"))) #change label
# 
# write.csv(piv.prop, 
#           file = file.path(outPath, ("V6_prop_obs.csv"))) #change label

write.csv(out.piv, 
          file = file.path(outPath, ("Mega_TMPgroups_av_proportion_max.csv"))) #change label

write.csv(out.piv.short, 
          file = file.path(outPath, ("Mega_TMPgroups_avGT1_propGT50pc.csv"))) #change label


write.csv(piv.meta, 
          file = file.path(outPath, ("Mega_TMPgroups_metadata.csv"))) #change label

```


