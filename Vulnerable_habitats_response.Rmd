---
title: "Generate the response variable for the VME models"
output: html_notebook
---

Currently thinking of two different approaches, one using the classified points as the main element, another one using the species data.
Different approach means different defition/set of rules for declaring VMEs!

# Approach 1.- Using the biotope classification

Requires: my.subs.small, trimmedwide, indsp, indval

## Input data and libraries
```{r}
library(dplyr)
library(rgdal)
library(indicspecies)
library(mvabund)

## pick a biotope and find (manually for now) the first classification level at which it splits

clname = "SubTmpMrgS6"
level = "level7"

hab_sub <- my.subs.small %>%
  filter(class==clname)%>%
  select(contains(level))%>%
  pull()

spe_sub <- trimmedwide %>%
  left_join(my.subs.small)%>%
  filter(class==clname)%>%
  #ungroup()%>%
  select(all_of(indsp))

spe_sub_nude <- spe_sub %>% ungroup() %>% select(-SampID)

## make a plot of species composition of subclasses

cl <- list(spe_sub_nude, as.factor(hab_sub))
names(cl)<-c("spe_sub", "hab_sub")
spe_subMV <- mvabund(cl$spe_sub)
plot(spe_subMV~hab_sub, data=cl)

```

## Question: do the subclasses are significantly different in their species composition?
```{r}
df <- left_join(spe_sub, my.subs.small) %>%
  mutate(hab_sub = as.factor(level10)) %>%
  ungroup()%>%
  as.data.frame()

Abus = df[,2:75]

cl_mglm = manyglm(mvabund(Abus)~hab_sub,data=df,
                  family="poisson")

an_cl=anova(cl_mglm,p.uni="adjusted")
an_cl$table
```

### Follow up question, if so, which taxa are responsible for the difference?
```{r}
sorted_clstats = sort(an_cl$uni.test[2,],decreasing=TRUE,
                      index.return=TRUE)
top5=sorted_clstats$x[1:5]
top5
```



